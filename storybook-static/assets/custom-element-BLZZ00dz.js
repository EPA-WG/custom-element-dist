const M="http://www.w3.org/1999/XSL/Transform",z="http://www.w3.org/1999/xhtml",W="http://exslt.org/common",f=(e,n)=>e.getAttribute?.(n),X=e=>e.nodeType===3,G=e=>typeof e=="string",Y=e=>e&&typeof e.nodeType=="number",E=(e,n="",t=document)=>(s=>(n&&s.append(w(t.ownerDocument||t,n)),s))((t.ownerDocument||t).createElement(e)),w=(e,n)=>(e.ownerDocument||e).createTextNode(n),O=e=>{for(;e.firstChild;)e.firstChild.remove();return e},R=e=>(e.getAttributeNames().map(n=>e.removeAttribute(n)),O(e)),J=e=>(e?.setAttribute("xmlns:xsl",M),e),K=e=>(e?.setAttribute("xmlns:xhtml",z),J(e)),H=(e,n)=>{const t=e.ownerDocument.createElementNS(e.namespaceURI,n);for(let s of e.attributes)t.setAttribute(s.name,s.value);for(;e.firstChild;)t.append(e.firstChild);return t};function C(e){return new DOMParser().parseFromString(e,"application/xml")}function I(e){return new XMLSerializer().serializeToString(e)}function D(e,n,t,s){const l=p=>e.ownerDocument.createElement(p),h=((p,y,d)=>(y.append(d=l(p)),d))(n,e);return[...t].forEach(p=>h.append(s(p))),h}function Q(e){return e.slot||(e.setAttribute||(e=E("span",e.textContent.replaceAll(`
`,""))),e.setAttribute("slot","")),e}function j(e,n,t){const s=typeof e;if(s==="function")debugger;if(s==="string")return E(n,e,t);if(s==="number")return E(n,""+e,t);if(e instanceof Array){const o=E("array");return e.map(h=>o.append(j(h,n,t))),o}const l=E(n,"",t);for(let o in e)Y(e[o])||typeof e[o]=="function"||e[o]instanceof Window||(typeof e[o]!="object"?l.setAttribute(o,e[o]):l.append(j(e[o],o,t)));return l}function k(e){if(S(e,"*",n=>[...n.childNodes].filter(t=>t.nodeType===3).forEach(t=>{if(t.parentNode.localName==="style")return;const s=t.data.matchAll(/{([^}]*)}/g);if(s){let l=0,o=p=>w(t,p||""),h=[];if([...s].forEach(p=>{p.index>l&&h.push(o(p.input.substring(l,p.index)));const y=e.querySelector("value-of").cloneNode();y.setAttribute("select",p[1]),h.push(y),l=p.index+p[0].length}),l<t.data.length&&h.push(o(t.data.substring(l,t.data.length))),h.length){for(let p of h)n.insertBefore(p,t);n.removeChild(t)}}})),"all"in e){let n=1;for(let t of e.all)t.setAttribute&&!t.tagName.startsWith("xsl:")&&t.setAttribute("data-dce-id",""+n++)}return e}function Z(e,n="xsl:stylesheet"){if(e.tagName===n||e.documentElement?.tagName===n)return k(e);const t=C(`<xsl:stylesheet version="1.0" xmlns:xsl="${M}" xmlns:xhtml="${z}" xmlns:exsl="${W}" exclude-result-prefixes="exsl" >
        <xsl:output method="xml" />
        <xsl:template match="/"><dce-root xmlns="${z}"><xsl:apply-templates select="*"/></dce-root></xsl:template>
        <xsl:template match="*[name()='template']"><xsl:apply-templates mode="sanitize" select="*|text()"/></xsl:template>
        <xsl:template match="*"><xsl:apply-templates mode="sanitize" select="*|text()"/></xsl:template>
        <xsl:template match="*[name()='svg']|*[name()='math']"><xsl:apply-templates mode="sanitize" select="."/></xsl:template>
        <xsl:template mode="sanitize" match="*[count(text())=1 and count(*)=0]"><xsl:copy><xsl:apply-templates mode="sanitize" select="@*"/><xsl:value-of select="text()"></xsl:value-of></xsl:copy></xsl:template>
        <xsl:template mode="sanitize" match="xhtml:*[count(text())=1 and count(*)=0]"><xsl:element name="{local-name()}"><xsl:apply-templates mode="sanitize" select="@*"/><xsl:value-of select="text()"></xsl:value-of></xsl:element></xsl:template>
        <xsl:template mode="sanitize" match="*|@*"><xsl:copy><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:copy></xsl:template>
        <xsl:template mode="sanitize" match="text()[normalize-space(.) = '']"/>
        <xsl:template mode="sanitize" match="text()"><dce-text><xsl:copy/></dce-text></xsl:template>
        <xsl:template mode="sanitize" match="xsl:value-of|*[name()='slot']"><dce-text><xsl:copy><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:copy></dce-text></xsl:template>
        <xsl:template mode="sanitize" match="xhtml:*"><xsl:element name="{local-name()}"><xsl:apply-templates mode="sanitize" select="*|@*|text()"/></xsl:element></xsl:template>
    </xsl:stylesheet>`),s=new XSLTProcessor,l=(a=>{S(a,"script",g=>g.remove());const i=a.content??a.firstElementChild?.content??a.body??a;re.forEach(g=>S(i,g,x=>ie(x,i)));const N=a.firstElementChild?.content||a.content,v=g=>{const x=C("<xhtml/>"),T=x.importNode(g,!0);return x.replaceChild(T,x.documentElement),K(T)};if(N){const g=E("div");return[...N.childNodes].map(x=>g.append(x.cloneNode(!0))),v(g)}return v(a.documentElement||a.body||a)})(e),o=C(`<xsl:stylesheet version="1.0"
        xmlns:xsl="${M}"
        xmlns:xhtml="${z}"
        xmlns:dce="urn:schemas-epa-wg:dce"
        xmlns:exsl="http://exslt.org/common"
        exclude-result-prefixes="exsl"
    >
    <xsl:template match="ignore">
        <xsl:choose>
            <xsl:when test="//attr">{//attr}</xsl:when>
            <xsl:otherwise>{def}</xsl:otherwise>
        </xsl:choose><xsl:value-of select="."></xsl:value-of></xsl:template>
    <xsl:template mode="payload"  match="attributes"></xsl:template>
    <xsl:template match="/">
        <xsl:apply-templates mode="payload" select="/datadom/attributes"/>
    </xsl:template>
    <xsl:template name="slot" >
        <xsl:param name="slotname" />
        <xsl:param name="defaultvalue" />
        <xsl:choose>
            <xsl:when test="//payload/*[@slot=$slotname]">
               <xsl:copy-of select="//payload/*[@slot=$slotname]"/>
            </xsl:when>
            <xsl:otherwise>
                <xsl:copy-of select="$defaultvalue"/>
            </xsl:otherwise>
        </xsl:choose>
    </xsl:template>
    <xsl:variable name="js-injected-body">
        <xsl:call-template name="slot" >
            <xsl:with-param name="slotname" select="''"/>
            <xsl:with-param name="defaultvalue"/>
        </xsl:call-template>
    </xsl:variable>
</xsl:stylesheet>`);s.importStylesheet(t);const h=s.transformToFragment(l,document),p=(a,i)=>a.querySelector(i),y=p(o,'template[mode="payload"]');if(!h)return console.error("transformation error",{xml:l.outerHTML,xsl:I(t)});const d=[];[...h.querySelectorAll("dce-root>attribute")].forEach(a=>{const i=H(a,"xsl:param"),N=f(a,"name");y.append(i);let v=f(i,"select")?.split("??");v||(v=["//"+N,`'${i.textContent}'`],R(i),i.setAttribute("name",N));let g;if(v?.length>1){i.removeAttribute("select");const x=p(o,'template[match="ignore"]>choose').cloneNode(!0);R(x.firstElementChild).append(w(x,"{"+v[0]+"}")),R(x.lastElementChild).append(w(x,"{"+v[1]+"}")),x.firstElementChild.setAttribute("test",v[0]),i.append(x),g=x.cloneNode(!0)}else g=H(a,"xsl:value-of");g.removeAttribute("name"),a.append(g),a.removeAttribute("select"),d.push(i)}),[...h.querySelectorAll("[value]")].filter(a=>a.getAttribute("value").match(/\{(.*)\?\?(.*)\}/g)).forEach(a=>{const i=f(a,"value");i&&a.setAttribute("value",oe(i))});for(const a of h.childNodes)y.append(o.importNode(a,!0));[...y.querySelectorAll("template")].forEach(a=>y.ownerDocument.documentElement.append(a));const $=p(o,'call-template[name="slot"]'),u=a=>{const i=$.cloneNode(!0),N=f(a,"name")||"";N&&i.firstElementChild.setAttribute("select",`'${N}'`);for(let v of a.childNodes)i.lastElementChild.append(v);return i};S(y,"slot",a=>a.parentNode.replaceChild(u(a),a));const c=k(o);return c.params=d,c}async function ee(e){return await new Promise((t,s)=>{const l=new XMLHttpRequest;l.open("GET",e),l.responseType="document",l.onload=()=>{l.readyState===l.DONE&&l.status===200&&t(l.responseXML||E("div",l.responseText)),s(l.statusText)},l.addEventListener("error",o=>s(o)),l.send()})}const te=(e,n)=>n.split("|").map(t=>t.trim()).map(t=>{if(t.includes("/")){const s=[],l=e.ownerDocument.evaluate(t,e);for(let o;o=l.iterateNext();)s.push(o);return s}return[...e.childNodes].find(s=>s.localName===t)||E(t)}).flat();function se(e,n,t,s){te(e,n).map(l=>{const o=e.ownerDocument,h=t.sliceEventSource,p=t.sliceElement,y=()=>[...l.childNodes].filter(d=>d.nodeType===3||d.localName==="value").map(d=>d.remove());if(h.getAttributeNames().map(d=>l.setAttribute(d,f(h,d))),[...l.childNodes].filter(d=>d.localName==="event").map(d=>d.remove()),t.type==="init"&&y(),l.append(j(t,"event",o)),p.hasAttribute("slice-value")){h.value===void 0?l.removeAttribute("value"):l.setAttribute("value",h.value);const d=B(f(p,"slice-value"),l);y(),l.append(w(o,d))}else{const d=h.value??f(p,"value");y(),d==null?[...l.childNodes].filter(A=>A.localName!=="event").map(A=>A.remove()):G(d)?l.append(w(o,d)):l.append(j(d,"value",l.ownerDocument))}})}function S(e,n,t){e.querySelectorAll&&[...e.querySelectorAll(n)].forEach(t)}const V=(e,n)=>(t=>e===t?null:t&&(t.querySelector(n)||V(t,n)))(e.getRootNode()),le=async(e,n)=>{if(!e||!e.trim())return[n];if(e.startsWith("#"))return(t=>{if(!t)return[];const s=t.querySelectorAll(e);if(s.length)return[...s];const l=t.getRootNode();return l===t?[]:V(l)})(n.parentElement);try{const t=await ee(e),s=new URL(e,location).hash;if(s){const l=t.querySelectorAll(s);return l.length?[...l]:[n]}return[t]}catch{return[n]}};function ne(e,n){if(X(e)){if(!X(n))debugger;return}for(let t of e.attributes)t.namespaceURI?n.setAttributeNS(t.namespaceURI,t.name,t.value):n.setAttribute(t.name,t.value),t.name==="value"&&(n.value=t.value)}function _(e,n=0){const t={};for(const s of e.childNodes){const l=f(s,"data-dce-id")||s.dceId||0;if(!t[l])l?t[l]=1:(t[l]=s.dceId=++n,s.setAttribute&&s.setAttribute("data-dce-id",s.dceId));else{const o=s.dceId=l+"-"+t[l]++;s.setAttribute&&s.setAttribute("data-dce-id",o)}s.childNodes.length&&_(s)}}function F(e,n){if(!n.length)return O(e);const t={};for(let s of e.childNodes)t[s.dceId],X(s)?(s.data.trim(),t[s.dceId||0]=s):t[f(s,"data-dce-id")||0]=s;for(let s of[...n]){const l=f(s,"data-dce-id")||s.dceId,o=t[l];o?(X(s)?o.nodeValue!==s.nodeValue&&(o.nodeValue=s.nodeValue):(ne(s,o),(o.childNodes.length||s.childNodes.length)&&F(o,s.childNodes)),delete t[l]):e.append(s)}for(let s of Object.values(t))s.remove()}function ae(e,n){return e.hasAttribute(n)||e.setAttribute(n,crypto.randomUUID()),e.getAttribute(n)}const oe=e=>[...e?.matchAll(/([^{}]*)(\{)([^}]+)}([^{}]*)/g)].map(t=>`${t[1]}{${P(t[3])}}${t[4]}`).join(""),P=e=>{if(!e.trim())return e;const n=e.split("??"),t=n.shift(),s=P(n.join("??"));return n.length?`concat( ${t} , substring( ${s} , (1+string-length( ${s} )) * string-length( ${t} ) ) )`:e},B=(e,n)=>{e=P(e);const t=n.ownerDocument.evaluate(e,n);switch(t.resultType){case XPathResult.NUMBER_TYPE:return t.numberValue;case XPathResult.STRING_TYPE:return t.stringValue}let s="";for(let l;l=t.iterateNext();)s+=l.textContent;return s},re="stylesheet,transform,import,include,strip-space,preserve-space,output,key,decimal-format,namespace-alias,template,value-of,copy-of,number,apply-templates,apply-imports,for-each,sort,if,choose,when,otherwise,attribute-set,call-template,with-param,variable,param,text,processing-instruction,element,attribute,comment,copy,message,fallback".split(","),ie=(e,n)=>{const t=E("xsl:"+e.localName);for(let s of e.attributes)t.setAttribute(s.name,s.value);for(;e.firstChild;)t.append(e.firstChild);if(e.parentElement)e.parentElement.replaceChild(t,e);else{const s=e.parentElement||n,l=[...s.childNodes];l.forEach((o,h)=>{o===e&&(l[h]=t)}),s.replaceChildren(...l)}};class ce extends HTMLElement{static observedAttributes=["src","tag","hidden"];async connectedCallback(){const n=await le(f(this,"src"),this),t=f(this,"tag"),s=t||"dce-"+crypto.randomUUID();for(const u of n)S(u.templateNode||u.content||u,"style",c=>{const a=c.closest("slot"),i=a?`slot[name="${a.name}"]`:"";c.innerHTML=`${s} ${i}{${c.innerHTML}}`,this.append(c)});const l=n.map(u=>Z(u)),o=l.map((u,c)=>(c=new XSLTProcessor,c.importStylesheet(u),c));Object.defineProperty(this,"xsltString",{get:()=>l.map(u=>I(u)).join(`
`)});const h=this,p=[...this.templateNode.querySelectorAll("[slice]")],y=p.map(u=>f(u,"slice")).filter(u=>!u.includes("/")).filter((u,c,a)=>a.indexOf(u)===c),d=l.reduce((u,c)=>(c.params&&u.push(...c.params),u),[]);class A extends HTMLElement{static get observedAttributes(){return d.map(c=>f(c,"name"))}#e=0;connectedCallback(){let c=this.childNodes;if(this.firstElementChild?.tagName==="TEMPLATE"){const m=this.firstElementChild;m.remove(),c=m.content.childNodes;for(const r of[...m.content.childNodes])if(r.localName==="style"){const b=ae(this,"data-dce-style");r.innerHTML=`${s}[data-dce-style="${b}"]{${r.innerHTML}}`,m.insertAdjacentElement("beforebegin",r)}else r.nodeType===1?m.insertAdjacentElement("beforebegin",r):r.nodeType===3&&m.insertAdjacentText("beforebegin",r.data)}const a=C("<datadom/>").documentElement,i=(m,r="")=>(b=>(r&&b.append(w(a,r)),b))(a.ownerDocument.createElement(m));D(a,"payload",c,Q),this.innerHTML="",D(a,"attributes",this.attributes,m=>i(m.nodeName,m.value)),D(a,"dataset",Object.keys(this.dataset),m=>i(m,this.dataset[m]));const N=D(a,"slice",y,m=>i(m,"")),v=m=>B(m,N);this.xml=a;const g=[],x=()=>{const m={};for(let r;r=g.pop();){const b=f(r.sliceElement,"slice");m[b]||(se(N,b,r),m[b]=r)}Object.keys(m).length!==0&&q()};let T;this.onSlice=m=>{m.stopPropagation?.(),m.sliceEventSource=m.currentTarget||m.target,g.push(m),T||(T=setTimeout(()=>{x(),T=0},10))};const q=this.transform=()=>{if(this.#e)debugger;this.#e=1,o.map((r,b)=>{const L=r.transformToFragment(a.ownerDocument,document);return L||console.error(`XSLT transformation error. xsl:
`,I(l[b]),`
xml:
`,I(a)),L}).map(r=>{r&&(_(r),F(this,r.childNodes))}),A.observedAttributes.map(r=>{let b=f(this.firstElementChild,r);b!==f(this,r)&&(this.setAttribute(r,b),this.#t(r,b))}),S(this,"[slice]",r=>{if(!r.dceInitialized){r.dceInitialized=1;const b=f(r,"slice-event");(b||"change").split(" ").forEach(L=>(r.localName==="slice"?r.parentElement:r).addEventListener(L,U=>{U.sliceElement=r,this.onSlice(U)})),(!b||b.includes("init"))&&(r.hasAttribute("slice-value")||r.hasAttribute("value")||r.value?this.onSlice({type:"init",target:r,sliceElement:r}):r.value=v(f(r,"slice")))}}),this.#e=0};q(),x()}#t(c,a){let i=this.xml.querySelector(`attributes>${c}`);i?R(i).append(w(i,a)):(i=E(c,a,this.xml),this.xml.querySelector("attributes").append(i))}attributeChangedCallback(c,a,i){!this.xml||this.#e||(this.#t(c,i),this.transform())}get dce(){return h}}const $=u=>{window.customElements.get(u)!==A&&window.customElements.define(u,A)};if(t)$(t);else{const u=s;this.setAttribute("tag",u),$(u);const c=document.createElement(u);this.getAttributeNames().forEach(a=>c.setAttribute(a,this.getAttribute(a))),c.append(...[...this.childNodes].filter(a=>a.localName!=="style")),this.append(c)}}get templateNode(){return this.firstElementChild?.tagName==="TEMPLATE"?this.firstElementChild.content:this}get dce(){return this}get xslt(){return C(this.xsltString)}}window.customElements.define("custom-element",ce);
